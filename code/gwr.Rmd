---
title: "GWR"
output: html_document
date: "2024-03-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
easypackages::packages ("sf", "sp", "spdep", "spatialreg", "GWmodel", "tmap", "mapview", "car", "RColorBrewer", 
                        "cowplot", "leafsync", "leaflet.extras2", "mapview", "tidyverse", "patchwork")
```

```{r}
project_directory <- dirname(getwd())
```

# Loading Data

## Toronto Map

```{r}
toronto_geojson_file <- file.path(project_directory, "data", "geodata", "neighbourhoods.geojson")
toronto <- st_read(toronto_geojson_file)
```

```{r}
plot(toronto)
```

```{r}
# the AREA_NAME is the name of the neighbourhood
# we need to clean the text so it is the same as all the other files
toronto$AREA_NAME <- tolower(trimws(gsub("\\(\\d+\\)", "", toronto$AREA_NAME)))
toronto$AREA_NAME <- gsub("\\(\\d+\\)", "", toronto$AREA_NAME)
toronto$AREA_NAME <- gsub("[[:punct:]]", "", toronto$AREA_NAME)

names(toronto)[names(toronto) == "AREA_NAME"] <- "neighbourhood"
```

------------------------------------------------------------------------

## Census Files

The census files contain 63 variables that will be used as indicators.

```{r}
census2011_path <- file.path(project_directory, "data", "census2011.csv")
census2011 <- read.csv(census2011_path)

census2016_path <- file.path(project_directory, "data", "census2016.csv")
census2016 <- read.csv(census2016_path)

census2021_path <- file.path(project_directory, "data", "census2021.csv")
census2021 <- read.csv(census2021_path)
colnames(census2021)[colnames(census2021) == "Neighbourhoods"] <- "X"
```

```{r}
names(census2021)
```

------------------------------------------------------------------------

## Crime Data

```{r}
crimes_path <- file.path(project_directory, "data", "crime", "major_crimes.csv")
major_crimes <- read.csv(crimes_path)
```

```{r}
major_crimes
```

# Exploratory Spatial Data Analysis

## Plot Number of Crimes by Neighbourhood

```{r}
# Loop through each year
for (year in 2013:2022) {
    
    file_path <- file.path(project_directory, "data", "crime", "by_neighbourhood", paste0(year, "crimes_per_neighbourhood.csv"))
   
    # Check if the file exists
    if (file.exists(file_path)) {
        crimes <- read.csv(file_path)
        
        # Perform spatial join between Toronto neighbourhoods and crime data
        merged_data <- merge(toronto, crimes, by.x = "neighbourhood", by.y = "NEIGHBOURHOOD_140", all.x = TRUE)
        
        # Create plot for the current year
        plot <- ggplot() + 
                    geom_sf(data = merged_data, aes(fill = num_crimes)) + 
                    scale_fill_gradient(name = "Number of Crimes", low = "lightblue", high = "darkred", limits= c(0, 2000)) +  
                    labs(title = paste("Crime Data", year))
        
        # Print or display the plot
        print(plot)
    } else {
        warning(paste("File not found for year", year))
    }
}
```

**Analysis:**

------------------------------------------------------------------------

## Plot of low-income percent

```{r}
# Loop through each year
for (year in seq(2011, 2021, by = 5)) {
    if (year == 2011) {
        census <- census2011
    } else if (year == 2016) {
        census <- census2016
    } else {
        census <- census2021
    }
    low_income_percent_only <- select(census, low_income_percent, X)
   
   
        
      # Perform spatial join between Toronto neighbourhoods and census data
      merged_data <- merge(toronto, low_income_percent_only, by.x = "neighbourhood", by.y = "X", all.x = TRUE)
        
        # Create plot for the current year
        plot <- ggplot() + 
                    geom_sf(data = merged_data, aes(fill = low_income_percent)) + 
                    scale_fill_gradient(name = "Low-income rate", low = "lightblue", high = "darkred", limits=c(0, 100)) +  
                    labs(title = paste("Low-income rate", year))
        
        print(plot)
}
```

**Analysis:**

------------------------------------------------------------------------

## Population Density Calculation

```{r}
toronto$area <- st_area(toronto)
```

```{r}
census2011$population_density <- census2011$total_population/toronto$area
census2016$population_density <- census2016$total_population/toronto$area
census2021$population_density <- census2021$total_population/toronto$area
```

```{r}
for (year in seq(2011, 2021, by = 5)) {
    if (year == 2011) {
        census <- census2011
    } else if (year == 2016) {
        census <- census2016
    } else {
        census <- census2021
    }
    pop_density <- select(census, population_density, X)
   
      merged_data <- merge(toronto, low_income_percent_only, by.x = "neighbourhood", by.y = "X", all.x = TRUE)
        
        # Create plot for the current year
        plot <- ggplot() + 
                    geom_sf(data = merged_data, aes(fill = low_income_percent)) + 
                    scale_fill_gradient(name = "Population Density", low = "lightblue", high = "darkred", limits=c(0, 100)) +  
                    labs(title = paste("Population Density", year))
        
        print(plot)
}
```

**Analysis:** The population density does not change much over the years.

*\*\*comment on population density compared to crime rates*

# Spatial Autocorrelation

```{r}
crimes2022 <- read.csv(file.path(project_directory, "data", "crime", "by_neighbourhood", "2022crimes_per_neighbourhood.csv"))
crimes2022 <- crimes2022[crimes2022$NEIGHBOURHOOD_140 != "nsa", ]
```

```{r}
toronto_nbq <- poly2nb(toronto, queen=TRUE)
toronto_listw <- nb2listw(toronto_nbq)
morans <- moran.test(crimes2022$num_crimes, listw=toronto_listw)
```

```{r}
morans
```

**Analysis:**
